service: lessons-api

custom:
  env: ${lower(${opt:stage, self:provider.stage})}
  vpcSettings:
    prod:
      securityGroupIds:
        - sg-052314a1eec2f2567
      subnetIds:
        - subnet-01a6b61d749d10c46
    current: ${ternary( ${self:custom.env}, prod, ${self:custom.vpcSettings.prod}, ~ )}

provider:
  name: aws
  runtime: nodejs20.x
  memorySize: 2048
  timeout: 60
  region: us-east-2
  iam:
    role: arn:aws:iam::428019619026:role/ChurchAppsRole
  environment:
    APP_ENV: ${self:custom.env}
  logs:
    restApi: true

functions:
  api:
    handler: lambda.universal
    events:
      - http: ANY {proxy+}
      - http: ANY /
    vpc: ${self:custom.vpcSettings.current}
  videoPingback:
    handler: lambda.videoPingback
    vpc: ${self:custom.vpcSettings.current}
  zipBundles:
    handler: lambda.zipBundles
    vpc: ${self:custom.vpcSettings.current}
    events:
      - schedule: rate(5 minutes)

plugins:
  - serverless-plugin-utils

resources:
  Resources:
    # API Gateway CloudWatch Role
    ApiGatewayCloudWatchRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: serverlessApiGatewayCloudWatchRole
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - apigateway.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs

    # CloudWatch Log Group for zip bundles function
    ZipBundlesLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/lessons-api-${self:custom.env}-zipBundles
        RetentionInDays: 5

    # CloudWatch Alarm for Lambda errors
    ZipBundlesErrorAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: lessons-api-${self:custom.env}-zipBundles-errors
        AlarmDescription: Alert when zipBundles function has errors
        MetricName: Errors
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Dimensions:
          - Name: FunctionName
            Value: lessons-api-${self:custom.env}-zipBundles
        TreatMissingData: notBreaching

    # CloudWatch Alarm for Lambda duration
    ZipBundlesDurationAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: lessons-api-${self:custom.env}-zipBundles-duration
        AlarmDescription: Alert when zipBundles function runs too long
        MetricName: Duration
        Namespace: AWS/Lambda
        Statistic: Average
        Period: 300
        EvaluationPeriods: 2
        Threshold: 50000
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: FunctionName
            Value: lessons-api-${self:custom.env}-zipBundles
        TreatMissingData: notBreaching

    # CloudWatch Dashboard for monitoring
    ZipBundlesDashboard:
      Type: AWS::CloudWatch::Dashboard
      Properties:
        DashboardName: lessons-api-${self:custom.env}-bundle-monitoring
        DashboardBody: !Sub |
          {
            "widgets": [
              {
                "type": "metric",
                "x": 0,
                "y": 0,
                "width": 12,
                "height": 6,
                "properties": {
                  "metrics": [
                    [ "AWS/Lambda", "Duration", "FunctionName", "lessons-api-${self:custom.env}-zipBundles" ],
                    [ ".", "Errors", ".", "." ],
                    [ ".", "Invocations", ".", "." ]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "us-east-2",
                  "title": "Bundle Zip Lambda Metrics"
                }
              },
              {
                "type": "log",
                "x": 0,
                "y": 6,
                "width": 24,
                "height": 6,
                "properties": {
                  "query": "SOURCE '/aws/lambda/lessons-api-${self:custom.env}-zipBundles'\n| fields @timestamp, @message\n| filter @message like /queue depth|processed|failed|error/\n| sort @timestamp desc\n| limit 100",
                  "region": "us-east-2",
                  "title": "Bundle Processing Logs",
                  "view": "table"
                }
              }
            ]
          }
